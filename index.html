<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Economy Collaborators - Smart Ranking</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; display: flex; height: 100vh; background: #fff; overflow: hidden; }
        #sidebar { width: 380px; border-right: 1px solid #d0d7de; background: #f6f8fa; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #d0d7de; background: #fff; }
        .filter-columns { display: flex; flex-grow: 1; overflow: hidden; }
        .column { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #eee; min-width: 0; }
        .column-label { font-size: 10px; font-weight: bold; padding: 8px; background: #eff1f3; text-align: center; color: #57606a; }
        .filter-list { flex-grow: 1; overflow-y: auto; padding: 5px; }
        #main { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .filter-item { display: flex; align-items: center; gap: 4px; font-size: 10px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; }
        .val-label { color: #888; font-size: 9px; margin-left: auto; }
        #tooltip { position: absolute; visibility: hidden; background: #fff; border: 1px solid #d0d7de; padding: 8px; border-radius: 4px; font-size: 11px; z-index: 100; pointer-events: none; }
        .label { font-size: 10px; fill: #57606a; font-weight: bold; }
        button { cursor: pointer; padding: 2px 4px; font-size: 10px; border: 1px solid #d0d7de; background: #fff; border-radius: 3px; }
        select { width: 100%; font-size: 12px; padding: 4px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0 0 10px 0; font-size:15px;">Smart Collaborators Rank</h3>
            <select id="period-select"></select>
        </div>
        <div class="filter-columns">
            <div class="column">
                <div class="column-label">FROM (Source)</div>
                <div style="padding:5px; display:flex; gap:2px;"><button onclick="toggleAll('src',true)">All</button><button onclick="toggleAll('src',false)">None</button></div>
                <div id="src-filters" class="filter-list"></div>
            </div>
            <div class="column">
                <div class="column-label">TO (Dest)</div>
                <div style="padding:5px; display:flex; gap:2px;"><button onclick="toggleAll('dst',true)">All</button><button onclick="toggleAll('dst',false)">None</button></div>
                <div id="dst-filters" class="filter-list"></div>
            </div>
        </div>
    </div>
    <div id="main"><div id="viz"></div></div>
    <div id="tooltip"></div>

<script>
const width = 800, height = 800, outerRadius = 260, innerRadius = 245;
const svg = d3.select("#viz").append("svg").attr("width", width).attr("height", height).append("g").attr("transform", `translate(${width/2},${height/2})`);
const tooltip = d3.select("#tooltip");

d3.csv("economy_collaborators.csv").then(data => {
    const allCountries = Array.from(new Set([...data.map(d => d.source), ...data.map(d => d.destination)])).sort();
    const periods = Array.from(new Set(data.map(d => `${d.year}-Q${d.quarter}`))).sort().reverse();
    const select = d3.select("#period-select");
    select.selectAll("option").data(periods).enter().append("option").text(d => d);

    // 初回UI生成
    renderFilters("src-filters", allCountries, "src-chk");
    renderFilters("dst-filters", allCountries, "dst-chk");

    function renderFilters(containerId, countries, cls, scores = new Map()) {
        const container = d3.select("#" + containerId);
        // 現在のチェック状態を保持
        const checkedStates = new Map();
        container.selectAll("input").each(function() { checkedStates.set(this.value, this.checked); });

        const sorted = [...countries].sort((a, b) => (scores.get(b) || 0) - (scores.get(a) || 0) || a.localeCompare(b));
        
        container.selectAll(".filter-item").remove();
        const items = container.selectAll(".filter-item").data(sorted).enter().append("label").attr("class", "filter-item");
        
        items.append("input").attr("type", "checkbox").attr("class", cls).attr("value", d => d)
             .property("checked", d => checkedStates.has(d) ? checkedStates.get(d) : true)
             .on("change", function() {
                 // 片方が1つだけ選ばれたら、もう片方をリランクする
                 reRank(cls === "src-chk" ? "dst" : "src");
                 update();
             });

        items.append("span").text(d => d);
        items.append("span").attr("class", "val-label").text(d => scores.has(d) ? d3.format(".2s")(scores.get(d)) : "");
    }

    function reRank(target) {
        const [y, q] = select.property("value").split("-Q");
        const activeSrc = d3.selectAll(".src-chk:checked").nodes().map(n => n.value);
        const activeDst = d3.selectAll(".dst-chk:checked").nodes().map(n => n.value);

        if (target === "dst") {
            const scores = d3.rollup(data.filter(d => d.year === y && d.quarter === q && activeSrc.includes(d.source)), v => d3.sum(v, d => +d.weight), d => d.destination);
            renderFilters("dst-filters", allCountries, "dst-chk", scores);
        } else {
            const scores = d3.rollup(data.filter(d => d.year === y && d.quarter === q && activeDst.includes(d.destination)), v => d3.sum(v, d => +d.weight), d => d.source);
            renderFilters("src-filters", allCountries, "src-chk", scores);
        }
    }

    window.toggleAll = (t, s) => { 
        d3.selectAll(t==='src'?".src-chk":".dst-chk").property("checked", s); 
        reRank(t==='src'?"dst":"src");
        update(); 
    };

    select.on("change", () => { reRank("src"); reRank("dst"); update(); });

    function update() {
        svg.selectAll("*").remove();
        const [y, q] = select.property("value").split("-Q");
        const activeSrc = new Set(d3.selectAll(".src-chk:checked").nodes().map(n => n.value));
        const activeDst = new Set(d3.selectAll(".dst-chk:checked").nodes().map(n => n.value));

        let filtered = data.filter(d => d.year === y && d.quarter === q && activeSrc.has(d.source) && activeDst.has(d.destination))
                           .sort((a,b) => +b.weight - +a.weight).slice(0, 150);
        if (!filtered.length) return;

        const nodes = Array.from(new Set([...filtered.map(d => d.source), ...filtered.map(d => d.destination)])).sort();
        const idxMap = new Map(nodes.map((n, i) => [n, i]));
        const matrix = Array.from({length: nodes.length}, () => new Float64Array(nodes.length));
        filtered.forEach(d => { const s = idxMap.get(d.source), t = idxMap.get(d.destination); if (s!==undefined && t!==undefined) matrix[s][t] = +d.weight; });

        const chord = d3.chordDirected().padAngle(0.04)(matrix);
        const color = d3.scaleOrdinal(d3.schemeTableau10).domain(nodes);

        const group = svg.append("g").selectAll("g").data(chord.groups).join("g");
        group.append("path").attr("fill", d => color(nodes[d.index])).attr("d", d3.arc().innerRadius(innerRadius).outerRadius(outerRadius));
        group.append("text").each(d => d.angle = (d.startAngle+d.endAngle)/2)
             .attr("class", "label").attr("transform", d => `rotate(${(d.angle*180/Math.PI-90)}) translate(${outerRadius+8}) ${d.angle>Math.PI?"rotate(180)":""}`)
             .attr("text-anchor", d => d.angle>Math.PI?"end":"start").text(d => nodes[d.index]);

        const ribbons = svg.append("g").selectAll("path").data(chord).join("path")
            .attr("d", d3.ribbon().radius(innerRadius)).attr("fill", d => color(nodes[d.source.index])).attr("fill-opacity", 0.6)
            .on("mouseover", (e, d) => {
                tooltip.style("visibility", "visible").html(`<strong>${nodes[d.source.index]} ➔ ${nodes[d.target.index]}</strong>: ${d.source.value.toLocaleString()}`);
                ribbons.style("opacity", r => (r === d) ? 1 : 0.1);
            })
            .on("mousemove", e => tooltip.style("top", (e.pageY-10)+"px").style("left", (e.pageX+10)+"px"))
            .on("mouseout", () => { tooltip.style("visibility", "hidden"); ribbons.style("opacity", 1); });
    }
    update();
});
</script>
</body>
</html>